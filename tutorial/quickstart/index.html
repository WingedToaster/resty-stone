<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Shlomi Assaf">
        <link rel="canonical" href="http://shlomiassaf.github.io/resty-stone/tutorial/quickstart/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>Quickstart - resty-stone</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">resty-stone</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorial <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            <li class="active">
                                <a href=".">Quickstart</a>
                            </li>
                        
                        </ul>
                    </li>
                
                
                </ul>
            

            
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                
                <li >
                    <a rel="next" href="../..">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li class="disabled">
                    <a rel="prev" >
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                
                <li>
                    <a href="https://github.com/shlomiassaf/resty-stone/">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
            
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#quick-start">Quick Start</a></li>
        
            <li><a href="#resource-metadata">Resource Metadata</a></li>
        
            <li><a href="#restlist">RestList</a></li>
        
            <li><a href="#authentication">Authentication</a></li>
        
            <li><a href="#custom-field-type-handling">Custom Field Type Handling</a></li>
        
            <li><a href="#endpoint-structure">Endpoint Structure</a></li>
        
            <li><a href="#response-container">Response Container</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="quick-start">Quick Start</h1>
<p>A demonstration of a simple REST API for a blog.<br />
We will be using <a href="https://github.com/keystonejs/generator-keystone">Keystone Generator</a> to scaffold a new KeystoneJS app.  </p>
<p><strong>Scaffolding KeystoneJS</strong><br />
You'll need Node.js &gt;= 0.10.x and MongoDB &gt;= 2.4.x installed.  </p>
<p>Install the Keystone generator (For any issued see <a href="https://github.com/keystonejs/generator-keystone">Keystone Generator</a>):  </p>
<pre><code>$ npm install -g generator-keystone
</code></pre>

<p>Create a new directory and generate a new KeystoneJS app:</p>
<pre><code>$ mkdir myblog
$ cd myblog
$ yo keystone
</code></pre>

<p>Enter <strong>Y</strong> when asked if it is a blog.</p>
<p>Install <code>resty-stone</code>:  </p>
<pre><code>npm install resty-stone --save
</code></pre>

<p>Create a new directory to hold Metadata for our REST exposed models:  </p>
<pre><code>$ mkdir rest_model
$ cd rest_model
</code></pre>

<h2 id="resource-metadata">Resource Metadata</h2>
<p>KeystoneJS Models are called List. By default every List model is hidden and access to it vie REST is not allowed.<br />
To expose a List model to REST we need to define a Metadata object describing a security model and logic for the resource.  </p>
<p>Create a new file in the directory <code>rest_model</code> call <code>Post.js</code>.<br />
Notice the file name is identical to the List model name, this is how <code>resty-stone</code> pair List model with Metadata.</p>
<pre><code>module.exports.default = {
    &quot;defaultKey&quot;: &quot;slug&quot;,
    &quot;permanentFilter&quot;: &quot;state:published&quot;,
    &quot;httpMethods&quot;: &quot;get&quot;,
    &quot;httpGroupMethods&quot;: &quot;get&quot;,
    &quot;columns&quot;: {
        &quot;visible&quot;: [
            &quot;title&quot;,
            &quot;content.brief&quot;
        ],
         &quot;no_filter&quot;: [
             &quot;state&quot;,
             &quot;slug&quot;,
             &quot;_id&quot;
         ]
    }
}

module.exports.authorized = {
    &quot;__extends__&quot; = &quot;default&quot;,
    &quot;permanentFilter&quot;: undefined,
    &quot;httpMethods&quot;: &quot;get post&quot;,
    &quot;columns&quot;: {
        &quot;visible&quot;: [
            &quot;title&quot;,
            &quot;publishedDate&quot;,
            &quot;slug&quot;,
            &quot;author&quot;,
            &quot;content&quot;,
            &quot;categories&quot;,
            &quot;tags&quot;
        ],
        &quot;no_filter&quot;: [
            &quot;state&quot;,
            &quot;slug&quot;,
            &quot;_id&quot;
        ]
    }
}

module.exports.admin = {
    &quot;__extends__&quot; = &quot;default&quot;,
    &quot;permanentFilter&quot;: undefined,
    &quot;httpMethods&quot;: &quot;get post delete&quot;,
    &quot;httpGroupMethods&quot;: &quot;get&quot;,
}
</code></pre>

<p>What is happening?<br />
We defined 3 different behaviors, 1 for each profile in the system: default(unauthorized), authorized and admin.<br />
We are also extending the <code>default</code> behavior using the <strong>extends</strong> key followed by the name of the profile we extend.<br />
Note that extending is only available for 1st level parameter, e.g: extending columns.visible will overwrite columns.no_filter</p>
<p><strong><u>default (unauthorized) behavior</u></strong>:<br />
The definition grants read only access to all users. (registered or guests)<br />
Only <code>published</code> Post instances are exposed.<br />
Only the <code>title</code> and the <code>brief</code> are exposed.  </p>
<p><strong><u>authorized behavior</u></strong>:<br />
The definition grants authorized users the ability to get and create Posts.  <br />
Overwriting <code>permanentFilter</code> means <strong>all</strong> post instances are exposed.<br />
There are also more visible columns exposed.  </p>
<p><strong><u>admin behavior</u></strong>:
The definition grants admin users the same ability as authorized users plus the ability to DELETE posts.      </p>
<p>A short description for every meta property:<br />
  - defaultKey          : The identifier column for the resource, default to _id. <code>www.restapi.com/api/:identifier</code><br />
  - permanentFilter     : A fixed filter added to every query on the resource.<br />
  - httpMethods         : The allowed methods when accessing the resource using an identifier. (space delimited)<br />
  - httpGroupMethods    : The allowed methods when accessing the resource without an identifier. (space delimited)<br />
  - columns.visible     : An array of column names the exposed by the api.
  - columns.no_filter   : An array of column names the user can not use for filtering.<br />
  - RestList            : Defines resource behaviors, an instance of restyStone.RestList or derived class instance.</p>
<p>This is it, we have now exposed <code>Post</code> to the WebAPI.<br />
The metadata acts as a security model for a resource, defining what is allowed at which security level.<br />
To define the behavior of a model, once access is allowed <code>RestList</code> class`s/instances are used.</p>
<h2 id="restlist">RestList</h2>
<p>RestList is responsible for 2 tasks:<br />
  1. The behavior of a exposed resource for every HTTP method and/or remote procedure calls (RPC).<br />
  2. Transformation of a result instance. (similar to view rendering)</p>
<p>resty-stone comes with a generic RestList implementation that handles GET, POST, PUT and DELETE http methods.<br />
The generic RestList return the result instance without transformation (as is).</p>
<p><strong><u>1. HTTP method handling / RPC</u></strong>:<br />
A RestList object is a simple Javascript object with properties matching HTTP method names (lower case).
Each property points to a function used to handle the request and return a result.<br />
A valid http method function accepts 2 parameters: <code>function(req, cb)</code><br />
<strong>req</strong>: Express REQUEST object with additional properties about the REST state.<br />
  - req.restApi - Metadata information about the resource.<br />
  - req.list    - Keystone List model for the resource.  </p>
<p><strong>cb</strong>: A Callback to send the result for the operation.<br />
Callback is fired with 3 parameters:<br />
  1. Error object, send undefined when no error occurred.<br />
  2. A <code>ResponseContainer</code> object with detailed information about the response.<br />
  3. A Boolean value indication if the results (in <code>ResponseContainer</code>) needs rendering (calling _render and applying custom file type transformation)  </p>
<p><strong>Remote Procedure Calls</strong>:<br />
It is possible to create your own method handlers for custom methods (NON HTTP VERB methods).<br />
It is very simple, simple define a new property, the name of the property is the method name used for accessing it.<br />
The value of the property is a method handler similar to get, post, put and delete handlers.<br />
To call an RPC add a query string parameter named <code>action</code> containing a value matching the method name you implemented in RestList.  </p>
<blockquote>
<p>Functions starting with _ are not accessible using RPC, use this convention to protect private function implemented in a RestList.</p>
</blockquote>
<pre><code>restList.doStudf= function(req, cb) {...};
</code></pre>

<pre><code>http://www.restapi.com/api/posts?action=doStuff
</code></pre>

<p><strong><u>1. Transformation / Rendering</u></strong>:<br />
Transformation is the final step before the object is sent to serialization (Custom field types, then JSON).<br />
The transformation is done using the <code>_render</code> function in RestList. <br />
The native implementation of _render in RestList does nothing.  You can override it and implement you logic.  </p>
<pre><code>var restyStone = require(&quot;resty-stone&quot;)(keystone);
var myRestlist = new restyStone.RestList();

myRestList._render = function(req, instance) {
     instance.newProperty = &quot;this is not part of the model but will show in the result&quot;;
     return instance;
 };
</code></pre>

<blockquote>
<p>Please review <code>./lib/RestList.js</code> (<a href="https://github.com/shlomiassaf/resty-stone/blob/master/lib/RestList.js">GitHub Link</a>) relative to resty-stone package to get a better understanding how to extend a RestList.</p>
</blockquote>
<p>You can implement a RestList by simply creating an instance of it and overwriting some functions.<br />
Functions not overwritten will keep their original behavior.  </p>
<pre><code>var restyStone = require(&quot;resty-stone&quot;)(keystone);
var myRestlist = new restyStone.RestList();

myRestList.get = function(req, cb) {
    cb(new restyStone.ApiException(400, false, &quot;I am faking this HTTP 400 error for you&quot;);
}
</code></pre>

<p>For complex scenarios inherit RestList and create instances of your newly derived class.  </p>
<p>To pair a model/profile with a your own version of RestList, set it in the metadata:  </p>
<pre><code>module.exports.default = {
    &quot;defaultKey&quot;: &quot;slug&quot;,
    &quot;permanentFilter&quot;: &quot;state:published&quot;,
    &quot;httpMethods&quot;: &quot;get&quot;,
    &quot;httpGroupMethods&quot;: &quot;get&quot;,
    &quot;columns&quot;: {
        &quot;visible&quot;: [
            &quot;title&quot;,
            &quot;content.brief&quot;
        ],
         &quot;no_filter&quot;: [
             &quot;state&quot;,
             &quot;slug&quot;,
             &quot;_id&quot;
         ]
    },
    &quot;RestList&quot; = myRestList
}
</code></pre>

<blockquote>
<p>Remember that every profile in every resource can use a different implementation of RestList.<br />
You can create an implementation of RestList per group, per item or any other combination you can think about.  </p>
</blockquote>
<h2 id="authentication">Authentication</h2>
<h2 id="custom-field-type-handling">Custom Field Type Handling</h2>
<h2 id="endpoint-structure">Endpoint Structure</h2>
<h2 id="response-container">Response Container</h2>
</div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/prettify-1.0.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>